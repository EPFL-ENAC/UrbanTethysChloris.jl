using Test
using UrbanTethysChloris.Soil: soil_moisture_conductivity_update

FT = Float64

@testset "MATLAB - Zurich" begin
    CASE_ROOT_H = 1
    CASE_ROOT_L = 1
    Kbot = NaN
    Kfc = 0.2
    Pcla = 0.2
    Phy = 10000.0
    Porg = 0.025
    Psan = 0.4
    PsiL50_H = [-3.0]
    PsiL50_L = [-4.0]
    PsiX50_H = [-4.5]
    PsiX50_L = [-4.5]
    Rrootl_H = [4000.0]
    Rrootl_L = [3800.0]
    SPAR = 2
    V = [
        5.492439078639919,
        9.17015669794592,
        9.173634656464724,
        9.174301668095026,
        18.348688551573321,
        18.348690046719391,
        36.697380130282383,
        36.697380130433764,
        36.697380130434240,
        91.743450326085593,
        91.743450326085593,
    ]
    ZR50_H = [NaN]
    ZR50_L = [NaN]
    ZR95_H = [1000.0]
    ZR95_L = [250.0]
    ZRmax_H = [NaN]
    ZRmax_L = [NaN]
    Zs = [0.0, 30.0, 80.0, 130.0, 180.0, 280.0, 380.0, 580.0, 780.0, 980.0, 1480.0, 1980.0]

    Vnew, O, OS, Psi_soil, Psi_s_H, Psi_s_L, Exwat_H, Exwat_L, Ko = soil_moisture_conductivity_update(
        V,
        Pcla,
        Psan,
        Porg,
        Kfc,
        Phy,
        SPAR,
        Kbot,
        CASE_ROOT_H,
        CASE_ROOT_L,
        ZR95_H,
        ZR95_L,
        ZR50_H,
        ZR50_L,
        ZRmax_H,
        ZRmax_L,
        Zs,
        Rrootl_H,
        Rrootl_L,
        PsiL50_H,
        PsiL50_L,
        PsiX50_H,
        PsiX50_L,
    )

    @test Vnew == V
    @test O ≈ [
        0.279204566909960,
        0.279526398247547,
        0.279595957417923,
        0.279609297650529,
        0.279610149804362,
        0.279610164755823,
        0.279610164940041,
        0.279610164940798,
        0.279610164940800,
        0.279610164940800,
        0.279610164940800,
    ]

    @test Psi_soil ≈ [
        3390.14705781264,
        3369.31231834020,
        3364.82918596917,
        3363.97020886760,
        3363.91534755670,
        3363.91438499733,
        3363.91437313757,
        3363.91437308884,
        3363.91437308869,
        3363.91437308869,
        3363.91437308869,
    ]

    @test Psi_s_H ≈ [-0.033031397962053]
    @test Psi_s_L ≈ [-0.033100894057440]

    @test Exwat_H ≈ reshape(
        [
            12559.3659775921,
            18872.8278238183,
            16299.6302944272,
            14038.4230526142,
            22483.8439045092,
            16656.4534748591,
            21480.6599036544,
            11788.8361065425,
            6469.85043127665,
            458.297216079448,
            0,
        ],
        1,
        11,
    )

    @test Exwat_L ≈ reshape(
        [
            41909.9994893982,
            44333.5711666851,
            24414.1144007298,
            13407.5378104797,
            9268.34631663937,
            0,
            0,
            0,
            0,
            0,
            0,
        ],
        1,
        11,
    )

    @test Ko ≈ [
        0.0167971240888116,
        0.0170643754764065,
        0.0171226536109245,
        0.0171338514019242,
        0.0171345669304586,
        0.0171345794850081,
        0.0171345796396936,
        0.0171345796403292,
        0.0171345796403312,
        0.0171345796403312,
        0.0171345796403312,
    ]
end
